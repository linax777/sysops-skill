---
name: sysops-skill
description: 系統維運知識庫目錄檢索和問答助手。核心流程：(1) 分層索引導航 (2) 按文件類型組合進行漸進式檢索，避免整文件加載。用戶問題涉及「從知識庫目錄回答問題/檢索資訊/查資料」時使用。
---

# 系統維運知識庫目錄檢索 Skill (sysops-skill)

## 知識庫目錄說明

- 知識庫存放於一個根目錄下，包含多種檔案類型（如 .md / .txt /.yaml / .json等），通常按類型或業務用途拆分為多級子目錄。
- 不要存放 word/excel/pdf 等檔案，不利於AI讀取內容，若有需要請轉成 md/txt/yaml/json 等格式再存放。
- 採用分層目錄索引檔案：
    - 根目錄有一個 index.md，說明主要的「領域目錄」及其用途。
    - 每個領域目錄下可有自己的 index.md，說明該目錄下有哪些子目錄/檔案，以及各自用途。
    - 更深入一層的子目錄也可繼續擁有 index.md，形成多級索引樹。
- 知識庫根目錄約定：
    - 預設認為知識庫位於當前專案根目錄下的 references/ 目錄。
    - 若使用者在對話中明確指定其他路徑（例如「我的知識庫在 /data/kb」或「用 ./docs 這個目錄作為知識庫」），則以使用者指定的路徑作為根目錄。
    - 當預設路徑 references/ 不存在或無法存取時，應向使用者確認實際的知識庫根目錄位置，而非隨意猜測。
- 單個業務檔案可能很大：
    - 不要直接用 Read 讀取整個檔案

## 預設目錄結構
```text
├── SKILL.md # Skill 使用說明(如何查詢)
├── references/ # 知識庫 (Knowledge Source)
│ ├── 01_triage_rules/ # 第一層：快速分選 (Progressive Level 1)
│ │ ├── alarm_mapping/ # 告警 ID 與處理建議的對照表
│ │ ├── symptoms_check.md # 常見症狀初判邏輯 (如：high-load、服務斷線)
│ │ └── index.md # 分類索引: 一份文件一行，方便用 grep 過濾
│ ├── 02_procedures/ # 第二層：標準作業 (Progressive Level 2)
│ │ ├── index.md # 分類索引:
│ │ ├── troubleshooting/ # 障礙排除 SOP
│ │ └── change_mgmt/ # 系統變更 SOP
│ ├── 03_system_context/ # 第三層：深度細節 (Progressive Level 3)
│ │ ├── index.md # 分類索引: 一份文件一行，方便用 grep 過濾
│ │ ├── architecture/ # 系統架構與拓樸
│ │ ├── Inventory/ # 資源清單（IP、Port....)
│ │ └── configurations/ # Config 基準文件
│ └── 04_atomic_assets/ # 可組合件 (Atomic Assets for Composability)
│ ├── index.md # 分類索引: 一份文件一行，方便用 grep 過濾
│ ├── scripts/ # 原子化指令腳本 (如：系統檢查, log 解析)
│ └── prompt_segments/ # 可重用的 Prompt 片段 (如：日誌分析標準格式)
├── assets/ # 靜態資源(例如SOP圖片，方便管理員直接閱讀 md 文件時引用)
└── tests/ # Skill 測試案例
    └── scenario_tests.md # 模擬告警情境測試 Prompt
```

## 定位 references 根目錄
- 根目錄優先使用使用者給出路徑：若使用者給出路徑（如 references/03_system_context），直接使用使用者提供的路徑。
- 預設根目錄：否則約定根目錄為當前專案下的 references/。
- 使用 shell 明確檢查目錄是否存在：優先使用 test -d references，或退而求其次使用 ls -d references。
- 注意：禁止使用 Glob "references" in . 這類模式來判斷目錄是否存在，Glob 只返回檔案路徑，不返回目錄本身，空結果並不能區分「目錄不存在」和「目錄存在但為空」。
- 只有在根目錄已透過 test -d 等方式確認存在時，才使用 Glob 在該目錄下檢索內容，並將目錄作為 path，例如：
    索引檔案：pattern="**/index.md", path="knowledge"
    所有 Markdown：pattern="**/*.md", path="knowledge"
- 若預設 knowledge/ 不存在（test -d 失敗）：不要猜測其他目錄，明確告知使用者未找到預設根目錄，並請使用者指定實際知識庫路徑。

## `index.md` 設計指南 (Best Practices)
為了最大化 Agent 檢索效率，並避免 Token 浪費與幻覺 (Lost in the middle)，知識庫維護者應遵循以下 `index.md` 撰寫原則：

### 1. 摘要式群組 (針對上層目錄)
在知識庫根目錄或領域大類（如 `03_system_context/`）的 `index.md` 中，**不要**窮舉所有底層檔案。
- **最佳作法**：僅列出重要的「子目錄用途」與「關鍵入口檔案」。
- **範例**：
  ```markdown
  - 目錄 `architecture/` : 存放各系統的架構圖與總體設計
  - 目錄 `configurations/` : 存放 Nginx, Redis 等配置基準
  - 檔案 `overall_topology.md` : (重點入口) 全公司基礎設施總拓樸圖
  ```

### 2. 標籤化與窮舉 (針對底層葉節點目錄)
只有在最底層的目錄（例如 `03_system_context/configurations/`），檔案數量有限（<50 個）且分類夠細的時候，才在該目錄的 `index.md` 中窮舉所有檔案。
- **最佳作法**：強制加入 `Tags: [標籤]` 前綴，並附上精煉的一句話摘要。
- **範例**：
  ```markdown
  - [nginx_tuning.md] Tags: [Nginx, performance, proxy] - Nginx 效能調優與反向代理基準設定
  - [redis_cluster.md] Tags: [Redis, cluster, cache] - Redis 分散式叢集配置參數
  ```
- **優勢**：Agent 讀取此索引時，可直接透過 Tags 精準命中目標，不需猜測檔案內容。


## 總體流程
1. 理解使用者需求與「快速直達判定 (Fast-Path)」

- 讀取使用者問題，提取：
    - 主題/領域關鍵詞（如「系統架構」「介面文件」）
    - 時間或範圍限制（如「2023 年 Q1」「最近版本」）
    - 需要的輸出類型（告警處理建議、原文內容、具體系統參數等）
- [重要：捷徑判定] 先評估是否能跳過目錄導航直接命中：
    - 💡 含有明確告警 ID / 錯誤碼：直接且優先針對 01_triage_rules/alarm_mapping/ 內或 symptoms_check.md 執行 grep 檢索。
    - 💡 含有確切檔案名稱：直接尋找該檔案名稱，不需走層層目錄。
    - 💡 含有特定服務名稱 (如 Nginx, MySQL)：若要全域搜尋，優先限定在 02_procedures/ 或 03_system_context/ 的對應子目錄路徑內搜尋。
- 確定知識庫根目錄：
    - 優先檢查使用者是否在問題中指定了知識庫路徑。
    - 否則使用預設根目錄 references/。
    - 若預設根目錄不存在或目錄結構異常，應向使用者詢問確認，而非自行假設。


2. 分層查看目錄索引 index.md (一般探勘流程)

- 若無法透過「快速直達判定」找到答案，才開始從「當前工作目錄」的 index.md 開始探勘。
- 使用一個「當前工作目錄」的概念：
    - 預設從使用者指定的知識庫根目錄開始；若使用者未指定，則使用預設的 references/ 目錄。
    - 在當前工作目錄下，若存在 index.md：
        - 使用 Read 讀取該檔案的前若干行（例如 limit=300），必要時分段繼續讀取。
        - 目標：
            - 先掃描 Tags 欄位（若有）作目錄鑽取決策
            - 了解當前目錄下有哪些子目錄和檔案
            - 理解每個子目錄/檔案的用途說明
            - 根據使用者問題，挑選最相關的若干個子目錄或檔案，構成候選集合。
    - 對於候選子目錄：
        - 切換上下文目錄後再搜尋，遞迴進入該子目錄，將其作為新的「當前工作目錄」，繼續查找其中的 index.md 並重複上述過程。
        - 在遞迴過程中，避免一次性深入所有分支，優先沿著與問題最相關的路徑向下鑽取。
    - 對於候選業務檔案：
        - 在完成必要的目錄層級探索後，收集這些檔案為最終的檢索目標清單。
        - 在優先級排序時：
            - 優先選擇用途說明與 Tags 包含與問題主題高度匹配的領域目錄和檔案
            - 其次考慮時間/版本等限制（若索引中有體現）
            - 通用說明類文件（如 README.md、總體設計類文件）放在較後優先級

3. 按檔案類型執行處理和檢索

- 總原則：
    - 優先從最相關、最精確的檔案開始
    - 每個檔案內都漸進式地局部檢索，避免一次性載入全部內容
    - 若當前檔案無法獲得滿意資訊，切換至下一個候選檔案

4. 迭代檢索

- 所有檔案類型皆使用統一的「多輪迭代檢索機制」（見上文公共檢索原則）

5. 答案組織與溯源

- 匯總多輪檢索得到的上下文，綜合回答使用者問題。
- 儘量：
    - 給出清晰、直接的回答
    - 指出使用過的檔案名（必要時包含大致位置，如章節或大概行數/頁數）
- 若答案基於推斷或資訊不完整：
    - 明確標註假設與不確定性
    - 提示使用者可補充更具體的檔案範圍或關鍵字


## 公共檢索原則

### 關鍵字選擇策略
- 從使用者問題提取 3-8 個關鍵字（含可能的英文縮寫、同義詞、上位/下位詞）
- 組合詞組（如、「API 介面 超時」）
- 必要時包含業務詞、技術術語、常見縮寫（如「uv」、「systemctl」、「barman」）


### grep 檢索基本原則
- 始終指定盡量精準的 include 和 path，避免搜尋整個目錄
- pattern 優先嘗試問題中的核心名詞、術語，再嘗試同義詞
- 對每個命中，僅讀取匹配附近的局部區域（上下若干行）
- 保存「檔案名 + 位置資訊 + 文本片段」


###多輪迭代檢索機制（最多 5 次）
所有檔案類型皆採用統一的迭代策略：

1.迭代控制
- 維護「已嘗試檢索次數」計數，最多 5 次
- 每次檢索後累加計數

2.每輪迭代流程
- 基於問題生成/更新檢索關鍵字（可包含同義詞、擴展詞）
- 選擇尚未充分檢索的檔案或檔案部分
- 執行檢索（grep/局部讀取/專用 Skill 呼叫）
- 分析取得的上下文片段
- 判斷是否足夠回答問題

3.終止條件
- 找到足夠支援回答的上下文；或
- 已達到 5 次嘗試仍未找到合適資訊

4.資訊不足時的處理
- 明確告知使用者資訊缺失或可能不在當前知識庫中
- 提供已找到的最接近資訊，並說明不確定性
- 提示使用者可如何縮小範圍（更具體的檔案名、關鍵字、時間範圍等）

### 注意事項
- 禁止第一次就直接呼叫：Glob "knowledge" in . 或任何試圖用 Glob 判定目錄存在性的呼叫，目錄存在性應透過 shell 命令（如 test -d）檢查。
- 使用本 Skill 查詢知識庫時，禁止使用網路搜尋等其他工具獲取知識


## 針對不同檔案類型的具體策略
1. Markdown / 文字類檔案（.md, .txt, .log 等）

1.1 候選檔案選擇

- 根據 index.md 和檔案名、路徑判斷相關度
- 優先檢索標題和目錄類檔案（如彙總文件、設計總覽）

1.2 grep 定位與局部讀取

- 使用 Grep 工具對指定候選檔案，include 限制具體副檔名（如 "*.md"）
- 對於有匹配的檔案，使用 Read 僅讀取匹配附近的局部區域：
    - 透過行號偏移和 limit 控制讀取（例如從匹配行附近往前后各讀取幾十行）
    - 避免整檔案讀取

1.3特殊處理

- 如內容僅是目錄/標題，根據連結或小節名繼續定位深入內容
- 應用「多輪迭代檢索機制」（見上文公共檢索原則）


## 回答風格與錯誤處理
- 回答風格
    - 盡量使用使用者提問的語言（中文/英文）作答。
    - 先給出結論，再給出簡要依據。
    - 如需要，可在後面列出引用的檔案和大致位置，例如：
        - 來源：design/api_gateway.md 第 100 行附近
- 資訊缺失或不確定時
    - 明確說明在當前知識庫中沒有找到完全匹配的資訊或僅能部分回答。
    - 不臆造事實。
    - 提示使用者可如何協助縮小範圍：
        - 指定更具體的目錄/檔案
        - 提供更精確的關鍵字或欄位名
        - 指定時間/版本範圍